<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>湛德财务项目管理系统</title>
  <link rel="stylesheet" href="/layui/css/layui.css">
  <link rel="stylesheet" href="/css/main.css">
  <!--    <link rel="stylesheet" href="../css/skin.css">-->
  <style type="text/css">
    .layui-table th{
      font-weight: bold;
    }
    #mainContent{
      padding: 20px;
    }
    .layui-layer-title {
      padding: 0 80px 0 20px;
      height: 42px;
      line-height: 42px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      color: #333;
      overflow: hidden;
      border-radius: 2px 2px 0 0;
    }
    .editinput{
      padding: 10px;
      width: 90%;
      border: 1px solid #5FB878;
    }
    .edittd{
      position: absolute;
      left: 0;
      right: 0;
      top:0;
      bottom: 0;
      padding: 20px;
    }
    .edittd:hover{
      cursor: pointer;
      background-color: #dcf0e2;
    }
    .headAddLeft{
      overflow: hidden;
      background-color: #efefef;
      padding: 10px 0 5px 20px;
      border-left: 5px solid #003c97;
      width: 200%;
    }
    .sqsel{
      padding: 3px;
      border: 1px solid #003c97;
      color: #003c97;
      font-size: 18px;
      margin-right: 20px;
    }
    .layui-input, .layui-textarea{
      display: inline;
      margin-right: 20px;
    }
    .layui-form-label {
      width: 120px;
    }
    /*.summaryContent > .layui-input{*/
    /*  border: none;*/
    /*  outline: none;*/
    /*}*/
    .layui-input, .layui-textarea{
      border: none;
      outline: none;
    }
    .summaryContent  label{
      font-weight: bold;
    }
  </style>
</head>
<body>
<div id="mainContent">
  <div id="rightContent">
    <div class="articleContent">
      <div class="layui-col-md12" style="font-size: 22px;font-weight: bold;line-height: 38px;text-align: center;margin-bottom: 30px;"><span style="padding: 10px 40px;border-bottom: 3px solid #003c97;">我的项目</span></div>
<!--      <div class="projectSummary">-->
<!--        <div class="layui-col-md3" style="width:100%; overflow: hidden;font-size: 16px;font-weight: bold;line-height: 50px;padding-left: 20px;background-color: #efefef;border-left: 5px solid #003c97;">项目汇总</div>-->
<!--      </div>-->
      <div class="headAddLeft" style="padding: 15px; width: 99%">
        <div class="layui-form">

          <label style="font-size: 14px;font-weight: bold;">项目名:</label>
          <input type="text" class="layui-input" id="pro_name" placeholder="请输入项目名" style="width: 120px;">
          <label style="font-size: 14px;font-weight: bold;">项目编号:</label>
          <input type="text" class="layui-input" id="pro_number" placeholder="请输入项目编号" style="width: 120px;">

<!--          </div>-->

          <div id="test6" style="display: inline">
            <label style="text-align: right;font-weight: bold;margin-top: 2px" >立项日期:</label>
            <input type="text" autocomplete="off" id="test-startDate-1" class="layui-input" placeholder="开始日期" style="width: 90px;text-align: center;">
            -
            <input type="text" autocomplete="off" id="test-endDate-1" class="layui-input" placeholder="结束日期" style="width: 90px;text-align: center;margin-left: 10px">
          </div>
<!--          <div class="layui-inline" id="role_change">-->
<!--            <div  id="sqselect_role" style="text-align: right;"><span style="margin-right: 5px;font-size: 16px;margin-bottom: 15px">角色切换：</span>-->
<!--              <input type="checkbox" checked="" id="switch" name="open" lay-skin="switch" lay-filter="switchTest" lay-text="部门|个人">-->
<!--            </div>-->
<!--          </div>-->
<!--          <div class="layui-inline" id="sqselect_person">-->
<!--            <span style="font-size: 14px;font-weight: bold;margin-bottom: 15px">成员筛选：</span>-->
<!--            <select class="sqsel" id="sqSelect_dep_person" lay-ignore >-->
<!--              <option value="">全部</option>-->
<!--            </select>-->
<!--          </div>-->

          <form class="layui-form layui-inline" lay-filter="params">
            <div class="layui-inline" style="margin-left: 30px;">
              <input type="checkbox" name="get_type[LX]" title="立项" checked lay-filter="get_type">
              <input type="checkbox" name="get_type[DD]" title="丢单" checked lay-filter="get_type">
            </div>
          </form>
          <div class="layui-inline" style="margin-left: 100px">
            <a class="layui-btn" style="background-color: #FD482C;" id="reset" onclick="search_pro(cur_page,'reset')">重置</a>
            <a class="layui-btn" style="background-color: #ca1c1d;" id="AnaBT" onclick="search_pro(cur_page,'search')">搜索</a>
          </div>
        </div>
        <div class="layui-form" style="margin-top: 20px" id="myPrjDeptSelect">
          <div class="layui-inline" id="role_change">
            <div  id="sqselect_role" style="text-align: right;"><span style="margin-right: 5px;font-size: 16px;margin-bottom: 15px">角色切换：</span>
              <input type="checkbox" checked="" id="switch" name="open" lay-skin="switch" lay-filter="switchTest" lay-text="部门|个人">
            </div>
          </div>
          <div class="layui-inline" id="sqselect_person" style="margin-left: 45px">
            <span style="font-size: 14px;font-weight: bold;margin-bottom: 15px">成员筛选：</span>
            <select class="sqsel" id="sqSelect_dep_person" lay-ignore >
              <option value="">全部</option>
            </select>
          </div>
        </div>
      </div>
      <div class="summaryContent" style="margin: 0 auto">
        <form class="layui-form">
          <div class="layui-form-item">
            <div class="layui-inline">
              <label class="layui-form-label">总拟成交价：</label>
              <div class="layui-input-inline">
                <input type="text" class="layui-input" id="total_transaction_price">
              </div>
            </div>
<!--            <div class="layui-inline">-->
<!--              <label class="layui-form-label">总支出金额：</label>-->
<!--              <div class="layui-input-inline">-->
<!--                <input type="text" class="layui-input" id="total_cost">-->
<!--              </div>-->
<!--            </div>-->
            <div class="layui-inline">
              <label class="layui-form-label">总回款：</label>
              <div class="layui-input-inline">
                <input type="text" class="layui-input" id="total_refunds">
              </div>
            </div>
            <div class="layui-inline">
              <label class="layui-form-label">总开票：</label>
              <div class="layui-input-inline">
                <input type="text" class="layui-input" id="total_invoice_amount">
              </div>
            </div>
          </div>
        </form>
      </div>
      <table class="layui-table" id="infoList" style="width: 100%">
        <colgroup>
          <col>
          <col>
          <col>
          <col>
          <col>
          <col>
        </colgroup>
        <thead>
        <tr>
          <th style="text-align: center">项目名称</th>
          <th style="text-align: center">项目编号</th>
          <th style="text-align: center">项目状态</th>
          <th style="text-align: center">拟成交价</th>
          <th style="text-align: center">开票</th>
          <th style="text-align: center">预计结余</th>
<!--          <th style="text-align: center">实际结余</th>-->
<!--          <th style="text-align: center">预计支出</th>-->
<!--          <th style="text-align: center">实际支出</th>-->
          <th style="text-align: center">实际回款</th>
<!--          <th style="text-align: center">采购成本</th>-->
<!--          <th>实际采购成本</th>-->
          <th style="text-align: center">立项时间</th>
          <th style="text-align: center">详情</th>
        </tr>
        </thead>
        <tbody id="listTbody">
        </tbody>
      </table>
    </div>
  </div>
</div>
<script src="/js/jquery.min.js"></script>
<script src="/layui/layui.js"></script>
<script src="/js/ajax.js"></script>
<script src="/js/jszip.js"></script>
<script src="/js/xlsx.js"></script>
<script src="/js/jquery.cookie.js"></script>
<script>
<!--  只有销售人员和部门主管才显示 我的项目 页面-->
  var role_id = window.sessionStorage.getItem("role_id")
  var cur_page = 1;
  var start_time ='';
  var end_time ='';
  var isManager = false;

  // var member_id = ''; //当用户为部门主管，选定的成员的id

  //默认项目搜索参数
  var sendObj = new Object();
  if($.cookie(window.location.href) == undefined){
    sendObj.page_size = 10;
    $.cookie(window.location.href, sendObj.page_size);
  }else{
    sendObj.page_size= $.cookie(window.location.href);

  }
  sendObj.page = 1;
  sendObj.member_id = '';
  sendObj.get_type = 'personal';

  //进入页面后立即执行搜索，传递默认参数

  //金额汇总的搜索
  if(role_id === '2') {
    isManager = true;
    // search_summary('/api/myitem/cost_detail/?get_type=department&member_id=');
    //111111
    sendObj.get_type = 'department'
    search_pro(1,'search');
    //获取部门成员列表
    get_person();
  }
  if(role_id !== '2'){
    $('#myPrjDeptSelect').hide()
    // $('#role_change').hide();
    // $('#sqselect_person').hide();
    // search_summary('/api/myitem/cost_detail/?get_type=personal&memeber_id=');
    //111111
    sendObj.get_type = 'personal'
    search_pro(1,'search');
  }
  layui.use('laydate', function(){
    var laydate = layui.laydate;
    laydate.render({
      elem: '#test6'
      //设置开始日期、日期日期的 input 选择器
      //数组格式为 2.6.6 开始新增，之前版本直接配置 true 或任意分割字符即可
      ,range: ['#test-startDate-1', '#test-endDate-1']
      ,theme: 'molv'
      ,change: function(value, date, endDate){
        start_time = value.split(" ")[0]
        end_time = value.split(" ")[2]
        // console.log(value.split(" ")); //得到日期生成的值，如：2017-08-18
        // console.log(start_time)
        // console.log(end_time)
      }
    });
  });
  layui.use('form', function(){
    var form = layui.form;
    form.on('checkbox(get_type)', (data)=>{search_pro(1,'search');});
    form.on('switch(switchTest)', function(data){
      // console.log(this.checked ? 'department' : 'personal');
      sendObj.get_type = this.checked ? 'department' : 'personal';
      if (sendObj.get_type === 'department' || sendObj.get_type === undefined){
        isManager = true;
        $("#sqselect_person").show()
        // if (sendObj.member_id !== '' && sendObj.member_id !== undefined){
        //   //搜索部门内某个成员的项目金额汇总
        //   search_summary('/api/myitem/cost_detail/?get_type=department&member_id='+sendObj.member_id.toString());
        //
        // }else{
        //   //搜索整个部门的项目金额汇总
        //   search_summary('/api/myitem/cost_detail/?get_type=department&member_id=');
        // }
      //  选择department
        //111111
        sendObj.get_type = 'department'
        search_pro(1,'search');
      }else {
        isManager = false;
        $("#sqselect_person").hide()
        // search_summary('/api/myitem/cost_detail/?get_type=personal&memeber_id=');
        //111111
        sendObj.get_type = 'personal'
        search_pro(1,'search');
      }
      // $("#listTbody").empty();
      //切换个人/部门，再刷新列表


      layer.msg('角色已切换至：'+ (this.checked ? '部门' : '个人'), {
        offset: '6px'
      });
      // layer.tips('温馨提示：请注意开关状态的文字可以随意定义，而不仅仅是ON|OFF', data.othis)
    });
    form.render()
  });
  //隐藏 个人/部门切换 checckbox 和 本部门内人员选择框


  function search_summary(url){
    getAjaxDate(url,'get','',function (rel) {
      // console.log(rel.data)
      var summary_data = rel.data[0]
      // $('#total_invoice_amount').val(summary_data.total_invoice_amount.toString() + '  元')
      // $('#rest_invoice_amount').val(summary_data.rest_invoice_amount.toString() + '  元')
      // $('#total_cost').val(numFormat(summary_data.total_cost.toString()) + '  元')
      $('#total_transaction_price').val(numFormat(summary_data.total_transaction_price.toString()) + '  元')
      $('#total_refunds').val(numFormat(summary_data.total_refunds.toString()) + '  元')
      $('#total_invoice_amount').val(numFormat(summary_data.total_invoice_amount.toString()) + '  元')
    })
  }
  //有memeber_id表示对该member搜索，否则只是对个人搜素，不带该参数
  function search_pro(cur_page,get_type) {
    if(tooFastCall( window.location.href,arguments.callee.name))return;//防止快速点击

    // var search_type = search_type;
    // console.log("test");
    let send_data = new Object();

    var search_obj = new Object();
    var reset_obj = new Object();

    // if(search_type === ''){
    //   search_type = sendObj.get_type;
    // }

    search_obj.page_size = sendObj.page_size;
    search_obj.page = sendObj.page;
    // search_obj.get_type = search_type;
    search_obj.get_type = sendObj.get_type
    reset_obj.page_size = sendObj.page_size;
    reset_obj.page = sendObj.page;
    // reset_obj.get_type = search_type;
    reset_obj.get_type = sendObj.get_type;

    if (sendObj.member_id !=='' && sendObj.member_id !== undefined){
      //当部门主管作为个人角色时，该值初始值为false,
      if (!isManager){
        search_obj.member_id = '';
      }else{
        search_obj.member_id = sendObj.member_id;
      }
    }else{
      search_obj.member_id = ''
    }
    // search_obj.member_id = sendObj.member_id;

    if(get_type === 'search') {
      // search_obj.item_name = $("#pro_name").val();
      search_obj.name = $("#pro_name").val();
      search_obj.number = $("#pro_number").val();
      search_obj.start_time = start_time;
      search_obj.end_time = end_time;

      params = layui.form.val('params');
      if(params["get_type[LX]"]=="on" &&params["get_type[DD]"]!="on" )
      {
        search_obj.status = 40;
      }
      else if(params["get_type[LX]"]!="on" &&params["get_type[DD]"]=="on" )
      {
        search_obj.status = 60
      }
      else{
        search_obj.status = ""
      }
      send_data = search_obj;
    }else if(get_type === 'reset'){
      //reset只搜索部门主管个人或销售人员，没有member_id字段
      // delete sendObj.member_id;
      // send_data = sendObj;
      // search_obj.member_id = ''
      sendObj.member_id = '';
      sendObj.page = 1;
      sendObj.page_size = $.cookie(window.location.href);
      reset_obj.member_id = '';
      send_data = reset_obj;

      $("#pro_name").val('');
      $("#pro_number").val('');
      $("#test-startDate-1").val('');
      $("#test-endDate-1").val('');
      $("#sqSelect_dep_person").val('');
    }
    // getAjaxDate('/api/item/search/','get',send_data,function (rel) {
    getAjaxDate('/api/myitem/','get',send_data,function (rel) {
      console.log(rel.data)
      layer.msg(rel.msg)
      $("#listTbody").empty()
      setTable(rel.data.results[1])
      // setTable(rel.data.results)

      //修改汇总数据
      var summary_data = rel.data.results[0][0]
      console.log('aaa:',summary_data)
      // $('#total_cost').val(numFormat(summary_data.total_cost.toString()) + '  元')
      $('#total_transaction_price').val(numFormat(summary_data.total_transaction_price.toString()) + '  元')
      $('#total_refunds').val(numFormat(summary_data.total_refunds.toString()) + '  元')
      $('#total_invoice_amount').val(numFormat(summary_data.total_invoice_amount.toString()) + '  元')

      sq.page({
        count : ((rel.data.total_items === undefined) ? 0 : rel.data.total_items),
        page : ((rel.data.page === undefined) ? 1 : rel.data.page),
        size : sendObj.page_size,
        jump : function(obj){
          sendObj.page = obj.curr;
          sendObj.page_size = obj.limit;
          $.cookie(window.location.href, obj.limit);
          search_pro(obj.curr,'search');
          // console.log(obj.limit);
        },
        bro : "#infoList"
      });
    })
    // console.log(sendObj)
  }
  function setTable(infoList) {
    /**
     *@infoList 是一个数组
     *  **/
    infoList.forEach(function (value) {
      //显示的按钮
      var buttonStr = '<button class="layui-btn editbt" onclick="openEditWindow(\''+encodeURIComponent(JSON.stringify(value))+'\')"><i class="layui-icon layui-icon-form"></i>   </button>';
      //将数据插入表格中
      $("#infoList").append('<tr>' +
              '<td style="text-align: center">'+value.name+'</td>' +
              '<td style="text-align: center">'+value.number+'</td>' +
              '<td style="text-align: center">'+value.project_status+'</td>' +
              '<td style="text-align: right">'+numFormat(value.protrans_price)+'</td>' +
              '<td style="text-align: right">'+numFormat(value.trans_price)+'</td>' +
              '<td style="text-align: right">'+numFormat(value.pro_surplus)+'</td>' +
              // '<td style="text-align: right">'+numFormat(value.surplus)+'</td>' +
              // '<td style="text-align: right">'+numFormat(value.pro_cost)+'</td>' +
              // '<td style="text-align: right">'+numFormat(value.cost)+'</td>' +
              '<td style="text-align: right">'+numFormat(value.ret_price)+'</td>' +
              // '<td style="text-align: right">'+numFormat(value.purchasing_cost)+'</td>' +
              // '<td>'+value.real_purchasing_cost+'</td>' +
              '<td style="text-align: center">'+value.approval_time+'</td>' +
              // '<td>'+'<button class="layui-btn layui-btn-normal layui-btn-sm" onclick="check_project_detail('+value.id+','+value.status+',\''+value.project_status+'\')" style="background-color: #2D93CA;padding: 0px 10px;" type="button"><i class="layui-icon layui-icon-form"></i>   </button>' + '</td>' +
              '<td style="text-align: center">'+buttonStr+'</td>' +
              '</tr>');
    })
  }
  function openEditWindow(data) {
    if(tooFastCall( window.location.href,arguments.callee.name))return;//防止快速点击
    // sq.open('cost_edit.html#data='+data)
    layer.open({
      // title: '<button  class="layui-btn layui-btn-sm" onclick="close_window()"><i class="layui-icon layui-icon-left"></i></button>'，
      title:'项目详情',
      content: 'my_project_detail.html#data='+data
      ,type:2
      ,area:['100%','100%']
      ,yes: function(index, layero){
      }
      ,btn2: function(index, layero){
      }
      ,cancel: function(){
        layer.msg("取消成功")
      }
    });
  }


  function get_person() {
    getAjaxDate('/api/user/?get_type=department','get',"",function (rel) {
      // console.log(rel.data)
      setselect(rel.data.results)
    });
  }
  function setselect(infoList){
    infoList.forEach(function (value) {
      //显示的按钮
      //将数据插入表格中
      $("#sqSelect_dep_person").append(new Option(value.nickname, value.id));
    })
  }

  //选择框切换用户，重新计算汇总，刷新项目列表
  $("#sqSelect_dep_person").on("change",function () {
    sendObj.member_id = $(this).val();
    $("#listTbody").empty();
    // if($(this).val() !== '' && $(this).val() !== undefined){
    //   // search_pro(1,'search','personal');
    //   search_summary('/api/myitem/cost_detail/?get_type=personal&member_id='+$(this).val().toString());
    // }
    // else{
    //   sendObj.member_id = ''
    //   // search_pro(1,'search','department');
    //   search_summary('/api/myitem/cost_detail/?get_type=department&member_id='+$(this).val().toString());
    // }
    //111111
    sendObj.get_type = 'department'
    search_pro(1,'search');
  });
</script>
</body>
</html>