<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>湛德财务项目管理系统</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="/layui/css/layui.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/sq.css">
  <style type="text/css">
    .layui-layer-setwin{
      color: #FFFFFF;
    }
    .layui-nav,.layui-nav-more{
      border-top-color:#b2b2b2 !important;
    }
    .sq-db-up{
      border: 1px solid #666;
      padding: 10px;
      background-color: #003c97;
      color: #fff;
      height: 30px;
      margin: auto;
    }
    .sq-db-down{
      border-left:1px solid #666 ;
      border-bottom:1px solid #666 ;
      border-right:1px solid #666 ;
      padding: 10px;
      height: 80px;
      cursor: pointer;
    }
    .span_div{
      font-size: 18px;
    }
    .sq-db-up span{
      margin-right: 10px;
    }
    .sq-db-down span{
      margin-right: 10px;
    }
    .sq-db-up strong{
      color: #ffff00;
    }
    .sq-db-down strong{
      margin: 5px;
      color: #008fb8;
    }
    
    .agency_div{
      height: 150px;
      width: 22%;
      padding: 5px 50px;
      display: inline-block;
    }


  </style>
</head>
<body>
<div style="margin-top:4px;" class="layui-tab layui-tab-brief" lay-filter="tab" lay-allowclose="true">

  <div>
    <div class="layui-tab-item layui-show">
      <div style="width: 100%;float: left;">
        <div class="sq-lm-card">
          <div style="overflow:hidden;">
            <div class="sq-lm-title">代办信息</div>
            <div class="sq-lm-hmd"></div>
          </div>
          <ul id="ul_scorll" class="sq-lm-list">
            <div id="index_approval" class="agency_div" style="padding-top: 30px">
              <div class="sq-db-up" style="text-align: center"><span class="span_div">立项申请</span></div>
              <div class="sq-db-down" style="text-align: center"><strong style="color: #c2c2c2">代办事项</strong>
                <div><span id="item_apply" style="font-size: 30px"></span>件</div>
              </div>
            </div>
            <div id="index_approvalList_edit" class="agency_div" >
              <div class="sq-db-up" style="text-align: center"><span class="span_div">立项修改</span></div>
              <div class="sq-db-down" style="text-align: center"><strong style="color: #c2c2c2">代办事项</strong>
                <div><span id="item_update" style="font-size: 30px"></span>件</div>
              </div>
            </div>
            <div id="index_approvalLost" class="agency_div" style="display: none" >
              <div class="sq-db-up" style="text-align: center"><span class="span_div">丢单审批</span></div>
              <div class="sq-db-down" style="text-align: center"><strong style="color: #c2c2c2">代办事项</strong>
                <div><span id="item_loss" style="font-size: 30px"></span>件</div>
              </div>
            </div>
            <!-- <div id="index_warning" class="agency_div">
              <div class="sq-db-up" style="text-align: center"><span class="span_div" style="color: #feae30">项目警告</span></div>
              <div class="sq-db-down" style="text-align: center"><strong style="color: #c2c2c2">代办事项</strong>
                <div><span id="item_warn" style="font-size: 30px">12</span>件</div>
              </div>
            </div> -->
            <div id="time_warning" class="agency_div">
              <div class="sq-db-up" style="text-align: center"><span class="span_div" style="color: #feae30">逾期警告</span></div>
              <div class="sq-db-down" style="text-align: center"><strong style="color: #c2c2c2">已逾期</strong>
              <div>
                <span id="expiration" style="font-size: 30px"></span>件
                <!-- <span id="deadline" style="font-size: 30px"></span>件 -->
              </div>
              </div>
            </div>
          </ul>
        </div>
      </div>
      <div class="sq-lm-card" id="recent_prj" style="display: none">
        <div style="overflow:hidden;">
          <div class="sq-lm-title">近期项目</div>
          <div class="sq-lm-hmd"></div>
        </div>
        <table class="layui-table" id="recent_project">
          <colgroup>
            <col>
            <col>
            <col>
            <col>
            <col>
            <!--                    <col>-->
          </colgroup>
          <thead>
          <tr>
            <th style="text-align: center">项目名称</th>
            <th style="text-align: center">项目编号</th>
            <th style="text-align: center">项目状态</th>
            <th style="text-align: center">拟成交价</th>
            <th style="text-align: center">开票</th>
            <th style="text-align: center">预计结余</th>
            <th style="text-align: center">实际回款</th>
            <th style="text-align: center">立项时间</th>
<!--            <th style="text-align: center">详情</th>-->
          </tr>
          </thead>
          <tbody id="reccent_prj_body">
          </tbody>
        </table>
      </div>
      <div class="sq-lm-card">
        <div style="overflow:hidden;">
          <div class="sq-lm-title">历史登录</div>
          <div class="sq-lm-hmd"></div>
        </div>
        <table class="layui-table" id="login_infoTable">
          <colgroup>
            <col>
            <col>
            <col>
            <col>
            <col>
            <!--                    <col>-->
          </colgroup>
          <thead>
          <tr>
            <th style="text-align: center">用户</th>
            <th style="text-align: center">设备</th>
            <th style="text-align: center">IP地址</th>
            <th style="text-align: center">登录地址</th>
            <th style="text-align: center">登录时间</th>
          </tr>
          </thead>
          <tbody id="jjTbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/layui/layui.js"></script>
<script src="/js/ajax.js"></script>
<script>
  var role_id = window.sessionStorage.getItem("role_id")
  if(role_id == 1 || role_id == 2){
    // $('#recent_prj').show();
    get_recent_prj();
  }
  getAjaxDate('/api/todoitem/','get','',function (rel) {
    $("#item_apply").text(rel.data.item_apply)
    $("#item_update").text(rel.data.item_update)
    $("#item_loss").text(rel.data.item_loss)
    $("#item_warn").text(rel.data.item_warn)
    $("#expiration").text(rel.data.item_overdue)
    $("#deadline").text(rel.data.item_overdue_warn)
    console.log(rel.data)
  })
  if(role_id === '4'){
    $("#index_approvalLost").show()
    $('.agency_div').css('width','17%')
  }
  if(role_id === '6'){
    $("#time_warning").hide()
    $('.agency_div').css('width','30%')
  }
  get_loginlog()
  function get_loginlog() {
    getAjaxDate('/api/loginlog/','get',{page:1,page_size:5},function (rel) {
      console.log(rel.data)
      $("#jjTbody").empty()
      setTable(rel.data.results)
    })
  }

  function setTable(infoList) {
    /**
     *@infoList 是一个数组
     *  **/
    infoList.forEach(function (value) {
      //显示的按钮
      //将数据插入表格中
      $("#login_infoTable").append('<tr>' +
              '<td style="text-align: center">'+value.nickname+'</td>' +
              '<td style="text-align: center">'+value.device+'</td>' +
              '<td style="text-align: center">'+value.ip+'</td>' +
              '<td style="text-align: center">'+value.address+'</td>' +
              '<td style="text-align: center">'+value.time+'</td>' +
              '</tr>');
    })
  }
  function get_recent_prj(){
    getAjaxDate('/api/myitem/?page_size=5&get_type=personal','get','',function (rel) {
      console.log(rel.data)
      $("#reccent_prj_body").empty()
      if(rel.data.results[1].length == 0) return;
      $('#recent_prj').show();
      setTable2(rel.data.results[1])
    })
  }
  function setTable2(infoList) {
    /**
     *@infoList 是一个数组
     *  **/
    infoList.forEach(function (value) {
      //显示的按钮
      //将数据插入表格中
      $("#recent_project").append('<tr>' +
              '<td style="text-align: center">'+value.name+'</td>' +
              '<td style="text-align: center">'+value.number+'</td>' +
              '<td style="text-align: center">'+value.project_status+'</td>' +
              '<td style="text-align: center">'+numFormat(value.protrans_price)+'</td>' +
              '<td style="text-align: center">'+numFormat(value.trans_price)+'</td>' +
              '<td style="text-align: center">'+numFormat(value.pro_surplus)+'</td>' +
              '<td style="text-align: center">'+numFormat(value.ret_price)+'</td>' +
              '<td style="text-align: center">'+value.time+'</td>' +
              // '<td style="text-align: center">'+'<button class="layui-btn layui-btn-normal layui-btn-sm" onclick="jump_my_prj(\''+value.number+'\')" style="background-color: #2D93CA;padding: 0px 10px;" type="button"><i class="layui-icon layui-icon-form"></i>   </button>' + '</td>' +
              '</tr>');
    })
  }
  $("#index_approval").click(function (){
    top.open_Tab("pages/Project_Management/approvalList.html?t="+$.now()+"#wait="+"1","103","立项申请")
    top.$("dd").removeClass("layui-this")
    top.$("#prj_apply").addClass("layui-this")
  })
  $("#index_approvalList_edit").click(function (){
    top.open_Tab("pages/Project_Management/approval_editList.html?t="+$.now()+"#wait="+"1","123","立项修改")
    top.$("dd").removeClass("layui-this")
    top.$("#prj_modify").addClass("layui-this")
  })
  $("#index_approvalLost").click(function (){
    top.open_Tab("pages/Project_Execute/Lost_orderList.html?t="+$.now()+"#wait="+"1","108","丢单审批")
    top.$("dd").removeClass("layui-this")
    top.$("#oder_lost_manage").addClass("layui-this")
  })
  $("#index_warning").click(function (){
    let url = "pages/index/warn.html?t="+$.now()+"#wait=1"
    top.open_Tab(url,"121","系统消息",true)
    top.$("dd").removeClass("layui-this")
    top.$("#warn").addClass("layui-this")
    // layer.msg("内测中！")
  })
  $("#time_warning").click(function (){
    let url = "pages/Project_Execute/duration_management.html"
    top.open_Tab(url,"113","逾期管理",true)
    top.$("dd").removeClass("layui-this")
    top.$("#duration_manage").addClass("layui-this")
  })
  function jump_my_prj(number) {
    let url = "pages/Project_Management/my_project.html?t="+$.now()+"#number="+number
    top.open_Tab(url,"124","我的项目")
    top.$("dd").removeClass("layui-this")
    top.$("#my_prj").addClass("layui-this")
  }
</script>
</body>
</html>